function [rfOut,errTot,phs,errRMSE,errSAR] = shimMSfun2(A,phs,beta,betaCtr,fdFlag,faThresh,maxItr,mask,B1p)

        % MS Shim Optimization
        if isempty(A)
            rfOut = zeros(8,1); % if empty slice, dont calculate in cost.
            errTot(idx) = 0;
            errRMSE(idx) = 0;
            errSAR(idx) = 0;

        else

            fdThresh = faThresh : -0.01 : 0;
            
            errTmpTot = [];
            errTmpRMSE = [];
            errTmpSAR = [];

            itr = 1;
            errTmpTot(itr) = inf;
            errTmpRMSE(itr) = inf;
            errTmpSAR(itr) = inf;

            if fdFlag                   
                % Use TV to avoid nulls
                TV0 = FD;
                ctrFlag = 0;

                %%%%%%%%%%%%%%%%%%

                % Method 1:
                TV0 = (TV0 * (B1p .* mask)) .* mask;

                %%%%%%%%%%%%%%%%%%

                TV0 = permute(TV0,[3,1,2,4]);
                TV0 = permute(TV0(:,:),[2,1]);
            end

            flag = 1;
            while flag % for target phase update
                itr = itr + 1;

                % Use TV to avoid nulls
                TV = 0;
                if fdFlag && itr > 2                      
                    tmp = abs(mtmp);

                    tmpIdx = 1+floor(ctrFlag/(maxItr+1)*length(fdThresh));
                    tmp = (tmp < fdThresh()) & (tmp>0);                       
                    if sum(tmp(:))
                        TV = sum(tmp(:)) * TV0 * 10;
                    end
                end

                tmpRF = (A'*A+beta(betaCtr)*speye(8)+TV'*TV)\(A'*exp(1i*phs));

                % calculate the excitation pattern
                mtmp = A*tmpRF;

                % update the target phase pattern
                phs = angle(mtmp);

                errTmpRMSE(itr) = norm(abs(mtmp)-1)^2;
                errTmpSAR(itr) = real(tmpRF'*tmpRF);
                errTmpTot(itr) = errTmpRMSE(itr) + beta(betaCtr) * errTmpSAR(itr);

                if (errTmpTot(itr) < 0.99999*errTmpTot(itr-1))
                    tmpRFOld = tmpRF;
                else
                    % if TV triggered, then restart the rf update
                    if (sum(TV(:)) ~= 0) && ctrFlag <= maxItr
                        flag = 1; ctrFlag = ctrFlag + 1;

                        itr = 1;
                        errTmpTot = [];
                        errTmpRMSE = [];
                        errTmpSAR = [];

                        errTmpTot(itr) = inf;
                        errTmpRMSE(itr) = inf;
                        errTmpSAR(itr) = inf;
                    else
                        flag = 0;
                        if (errTmpTot(itr) <= errTmpTot(itr-1))
                            rfOut = tmpRF;
                            errTot = errTmpTot(itr);
                            errRMSE = errTmpRMSE(itr);
                            errSAR = errTmpSAR(itr);
                        else
                            rfOut = tmpRFOld;
                            errTot = errTmpTot(itr-1);
                            errRMSE = errTmpRMSE(itr-1);
                            errSAR = errTmpSAR(itr-1);
                        end
                    end                     
                end
            end
        end
end